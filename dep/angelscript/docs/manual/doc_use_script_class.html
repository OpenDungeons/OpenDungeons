<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>AngelScript: Using script classes</title>
<link href="tabs.css" rel="stylesheet" type="text/css">
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.9 -->
<div class="contents">
<h1><a class="anchor" name="doc_use_script_class">Using script classes </a></h1>When there are multiple objects controlled by the same script implementation it may be favourable to use script classes, rather than global script functions. Using script classes each instance can have it's own set of variables within the class, contrary to the global functions that needs to rely on global variables to store persistent information.<p>
Of course, it would be possible to duplicate the script modules, so that there is one module for each object instance, but that would be impose a rather big overhead for the application. Script classes don't have that overhead, as all instances share the same module, and thus the same bytecode and function ids, etc.<h2><a class="anchor" name="doc_use_script_class_1">
Instanciating the script class</a></h2>
Before instanciating the script class you need to know which class to instanciate. Exactly how this is done depends on the application, but here are some suggestions.<p>
If the application knows the name of the class, either hardcoded or from some configuration, the class type can easily be obtained by calling the module's <a class="el" href="classas_i_script_module.html#7fbc2bd888b248d2c2ee2d953b49eefc">GetTypeIdByDecl</a> with the name of the class. The application can also choose to identify the class through some properties of the class, e.g. if the class implements a predefined <a class="el" href="classas_i_script_engine.html#e2d89b82561b7f9843f35693c664589f">interface</a>. Then the application can enumerate the class types implemented in the script with <a class="el" href="classas_i_script_module.html#33ebba99a6358ccfb0c154fca7f58f77">GetObjectTypeByIndex</a> and then examine the type through the <a class="el" href="classas_i_object_type.html">asIObjectType</a> interface.<p>
A third option, if you're using the <a class="el" href="doc_addon_build.html">script builder add-on</a>, is to use the metadata to identify the class. If you choose this option, use the <a class="el" href="classas_i_script_module.html">asIScriptModule</a> to enumerate the declared types and then query the <a class="el" href="doc_addon_build.html">CScriptBuilder</a> for their metadata.<p>
Once the object type is known you create the instance by calling the class' factory function, passing it the necessary arguments, e.g. a pointer to the application object which the script class should be bound to. The factory function id is found by querying the <a class="el" href="classas_i_object_type.html">asIObjectType</a>.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// Get the object type</span>
<a class="code" href="classas_i_script_module.html" title="The interface to the script modules.">asIScriptModule</a> *module = engine-&gt;<a class="code" href="classas_i_script_engine.html#9f7cdc52b59034e6e55eb8a56b427aa4" title="Return an interface pointer to the module.">GetModule</a>(<span class="stringliteral">"MyModule"</span>);
<a class="code" href="classas_i_object_type.html" title="The interface for an object type.">asIObjectType</a> *type = engine-&gt;<a class="code" href="classas_i_script_engine.html#52f3e08240c9fc493793036721cbd5ce" title="Returns the object type interface for type.">GetObjectTypeById</a>(module-&gt;<a class="code" href="classas_i_script_module.html#7fbc2bd888b248d2c2ee2d953b49eefc" title="Returns a type id by declaration.">GetTypeIdByDecl</a>(<span class="stringliteral">"MyClass"</span>));

<span class="comment">// Get the factory function id from the object type</span>
<span class="keywordtype">int</span> factoryId = type-&gt;<a class="code" href="classas_i_object_type.html#3aa646c8a7d7e1efb5af2bde6f58b731" title="Returns the factory id by declaration.">GetFactoryIdByDecl</a>(<span class="stringliteral">"MyClass @MyClass()"</span>);

<span class="comment">// Prepare the context to call the factory function</span>
ctx-&gt;<a class="code" href="classas_i_script_context.html#d048f847854cc8b95fde0380a8b39d7e" title="Prepares the context for execution of the function identified by funcId.">Prepare</a>(factoryId);

<span class="comment">// Execute the call</span>
ctx-&gt;<a class="code" href="classas_i_script_context.html#8e52894432737acac2e1a422e496bf84" title="Executes the prepared function.">Execute</a>();

<span class="comment">// Get the object that was created</span>
<a class="code" href="classas_i_script_object.html" title="The interface for an instance of a script object.">asIScriptObject</a> *obj = *(<a class="code" href="classas_i_script_object.html" title="The interface for an instance of a script object.">asIScriptObject</a>**)ctx-&gt;<a class="code" href="classas_i_script_context.html#889bf11123beba669637849c8e9b2b86" title="Returns the address of the returned value.">GetAddressOfReturnValue</a>();

<span class="comment">// If you're going to store the object you must increase the reference,</span>
<span class="comment">// otherwise it will be destroyed when the context is reused or destroyed.</span>
obj-&gt;<a class="code" href="classas_i_script_object.html#3e08890e31163e4d33c0f27dc9072662" title="Increase reference counter.">AddRef</a>();
</pre></div><p>
The factory function is <a class="el" href="doc_call_script_func.html">called as a regular global function</a> and returns a handle to the newly instanciated class.<h2><a class="anchor" name="doc_use_script_class_2">
Calling a method on the script class</a></h2>
Calling the methods of the script classes are similar to <a class="el" href="doc_call_script_func.html">calling global functions</a> except that you obtain the function id from the <a class="el" href="classas_i_object_type.html">asIObjectType</a>, and you must set the object pointer along with the rest of the function arguments.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// Obtain the id of the class method</span>
<span class="keywordtype">int</span> funcId = type-&gt;<a class="code" href="classas_i_object_type.html#20699d68d56dc614c3105506b68ffed9" title="Returns the method id by declaration.">GetMethodIdByDecl</a>(<span class="stringliteral">"void method()"</span>);

<span class="comment">// Prepare the context for calling the method</span>
ctx-&gt;<a class="code" href="classas_i_script_context.html#d048f847854cc8b95fde0380a8b39d7e" title="Prepares the context for execution of the function identified by funcId.">Prepare</a>(funcId);

<span class="comment">// Set the object pointer</span>
ctx-&gt;<a class="code" href="classas_i_script_context.html#10d3c152b25d07584999f4d9fe5ce8b1" title="Sets the object for a class method call.">SetObject</a>(obj);

<span class="comment">// Execute the call</span>
ctx-&gt;<a class="code" href="classas_i_script_context.html#8e52894432737acac2e1a422e496bf84" title="Executes the prepared function.">Execute</a>();
</pre></div><h2><a class="anchor" name="doc_use_script_class_3">
Receiving script classes</a></h2>
In order for the application to register a function that receives a script class it must first know the type. Of course, since the class is declared in the script it isn't possible to know the type before the script is compiled. Instead the application can register an interface with the engine. The function can then be registered to receive a handle to that interface.<p>
<div class="fragment"><pre class="fragment"><span class="comment">// Register an interface</span>
engine-&gt;<a class="code" href="classas_i_script_engine.html#e2d89b82561b7f9843f35693c664589f" title="Registers an interface.">RegisterInterface</a>(<span class="stringliteral">"IMyObj"</span>);

<span class="comment">// You can also register methods with the interface if you wish to force the script class to implement them</span>
engine-&gt;<a class="code" href="classas_i_script_engine.html#43bd2c12c94a55c22be76d209de93f1a" title="Registers an interface method.">RegisterInterfaceMethod</a>(<span class="stringliteral">"IMyObj"</span>, <span class="stringliteral">"void RequiredMethod()"</span>);

<span class="comment">// Register a function that receives a handle to the interface</span>
engine-&gt;<a class="code" href="classas_i_script_engine.html#754fafd069d8e0c19baff2dc222893b0" title="Registers a global function.">RegisterGlobalFunction</a>(<span class="stringliteral">"void ReceiveMyObj(IMyObj @obj)"</span>, <a class="code" href="angelscript_8h.html#78f8f2c7f1c88b12e74a5ac47b4184ae" title="Returns an asSFuncPtr representing the function specified by the name.">asFUNCTION</a>(ReceiveMyObj), <a class="code" href="angelscript_8h.html#3ec92ea3c4762e44c2df788ceccdd1e468ae43cc91cdfc3fa4590c9e6164e4f4" title="A cdecl function.">asCALL_CDECL</a>);
</pre></div><p>
The function that receives the interface should be implemented to take a pointer to an <a class="el" href="classas_i_script_object.html">asIScriptObject</a>.<p>
<div class="fragment"><pre class="fragment"><a class="code" href="classas_i_script_object.html" title="The interface for an instance of a script object.">asIScriptObject</a> *gObj = 0;
<span class="keywordtype">void</span> ReceiveMyObj(<a class="code" href="classas_i_script_object.html" title="The interface for an instance of a script object.">asIScriptObject</a> *obj)
{
  <span class="comment">// Do something with the object</span>
  <span class="keywordflow">if</span>( obj )
  {
    <span class="keywordflow">if</span>( doStore )
    {
      <span class="comment">// If the object is stored, we shouldn't release the handle</span>
      gObj = obj;
    }
    <span class="keywordflow">else</span>
    {
      <span class="comment">// If the object is not stored, we must release the handle before returning</span>
      obj-&gt;<a class="code" href="classas_i_script_object.html#4bed3c3ac9f16294985835747aa122d3" title="Decrease reference counter.">Release</a>();
    }
  }
}
</pre></div><p>
If you don't want to use interfaces like this, then you may want to look into the <a class="el" href="doc_adv_var_type.html">variable argument type</a> or the generic container <a class="el" href="doc_addon_any.html">any add-on</a>, which are ways that can be used to receive values and objects of which the type is not known beforehand. </div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sun Jul 3 18:09:37 2011 for AngelScript by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.9 </small></address>
</body>
</html>
